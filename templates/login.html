<!doctype html>
<html>
  <head>
    <title>SQLite Web: {{ dataset.base_name }}</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noindex">
    <link rel=stylesheet type=text/css href="{{ url_for('static', filename='css/bootstrap.min.css') }}" />
    <!--<link rel=stylesheet type=text/css href="{{ url_for('static', filename='css/sqlbrowse.css') }}" />
    <link rel=stylesheet type=text/css href="{{ url_for('static', filename='css/syntax-highlight.css') }}" />-->
    {% block extra_head %}{% endblock %}
    <script src="{{ url_for('static', filename='js/jquery-1.11.0.min.js') }}" type="text/javascript"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/Chart.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/Chart.bundle.js') }}"></script>
    <script src="{{ url_for('static', filename='js/Chart.Geo.js') }}"></script>
    <script type="text/javascript">
      $(function() {
        $('a#toggle-helper-tables').on('click', function(e) {
          e.preventDefault();
          $('ul#helper-tables').toggle();
        });
        $('input#table-search').on('keyup', function(e) {
          var searchQuery = $(this).val().toUpperCase();
          $('li.table-link').each(function() {
            var elem = $(this),
                tableName = elem.find('a').prop('innerText').toUpperCase();
            elem.toggle(tableName.indexOf(searchQuery) != -1);
          });
        });
      });
    </script>
  </head>

<body>

    <div class="container">

      <div class="row">
        <div class="col-lg-6">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h5>Active Union Organizations per Type and Year</h5>
            </div>
            <div class="panel-body">
              <canvas id="bar-chart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h5>Active Union Organizations per District</h5>
            </div>
              <canvas id="map" class="panel-body"></canvas>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-6">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h5>Strike Notices per Year</h5>
            </div>
            <div class="panel-body">
              <canvas id="bar-chart2"></canvas>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h5>Active Union Organizations per Activity Sector</h5>
            </div>
            <div class="panel-body">
              <canvas id="bar-chart3"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-12">
          <div class="panel panel-default">
            <div class="panel-body">
              <form action="{{ url_for('login') }}" class="form" id="form" method="post">
                <div class="form-group">
                  <label for="id_password">Enter your password to login into the administration panel</label>
                  <input class="form-control" id="id_password" name="password" type="password" value="" />
                  <button class="btn btn-primary" type="submit">Login</button>
                </div> 
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    
    
    <script>
     new Chart(document.getElementById("bar-chart"), {
     type: 'bar',
     data: {
       labels: {{ dataset.barchart_labels | safe }},
       datasets: [
        {
          label: "Union Confederations",
          data: {{ dataset.barchart_data | safe }},
          backgroundColor: '#228B22' // green
        },
        {
          label: "Union Federations",
          data: {{ dataset.barchart_data2 | safe }},
          backgroundColor: '#FFD700' // yellow

        },
        {
          label: "Unions",
          data: {{ dataset.barchart_data3 | safe }},
          backgroundColor: '#FF0000' // red
        },
        {
          label: "Union Unions",
          data: {{ dataset.barchart_data4 | safe }},
          backgroundColor: '#0000FF' // blue
        }
      ]
    },
    options: {
      legend: { display: true },
      scales: {
        xAxes: [{ stacked: true }],
        yAxes: [{ stacked: true }]
      }
    }
    });

  var i = 0;
  var distPT = [];
  var distritosPT = [];
  var value = "";
  const distritos2 = [];
  var valores = {{dataset.map_data}};
  var dict = {};
	

	fetch("{{ url_for('static', filename='data/Iberic.json') }}").then(r => r.json()).then((ib) => {
      const distritos = ib.features;

      distritos.forEach(function(entry) {

        value = entry.properties.name.toUpperCase();

        if(!(typeof(entry.properties.admin) == "undefined")){

          if(value != "AZORES" && value != "MADEIRA"){

            if(value == "Ã‰VORA"){
              value = "EVORA";
            }
            
            
            distPT.push(value);
            entry.properties.name = value;
            distritosPT.push(entry);
            distritos2.push(entry);

          }
        }
        else{

            if (value != "CANARIAS" && value != "BALEARES"){

              entry.properties.name = value;
              distritos2.push(entry);
            }

        }

      });

      distritosPT.sort(function(a, b){
        var keyA = a.properties.name.toUpperCase();
        var keyB = b.properties.name.toUpperCase();
        if(keyA < keyB) return -1;
        if(keyA > keyB) return 1;
        return 0;
      });

      distPT.sort();

      console.log(distPT);
      console.log(distritos2);

      distPT.forEach(function(district) {

        dict[district] = valores[i];

        i++;

      });

      valores.sort(function(a, b){return a - b});

      var orgValue = 0;
      var value = 0;
      var j=0;
      var max = valores.reduce(function(a, b) {
  		return Math.max(a, b);
	  });

    function orgValues(district) {

      if (!(district in dict)){
        return 0;
      }
      else{
        orgValue = dict[district];
      }
    	
    	i = 0;

    	for(j=10; j <= 100; j=j+10){
    	  index = j /100. * (valores.length-1);
      	if (Math.floor(index) == index) {
      		result = valores[index];
      	} 
    	  else {
        	i = Math.floor(index)
        	fraction = index - i;
        	result = valores[i] + (valores[i+1] - valores[i]) * fraction;
        }

    	  if(orgValue <= result){
    		  return result / max;
        }
	    }
	  }


      function orgValuess(district){
        orgValue = dict[district];

        for(j=1; j <= 100; j++){

          value = percentile(j, valores);

          if(orgValue <= value){
            return j / 100;
          }
        }
      }

      const chart = new Chart(document.getElementById("map").getContext("2d"), {
        type: 'choropleth',
        data: {
          labels: distritosPT.map((d) => d.properties.name),
          datasets: [{
            label: 'Distritos',
            outline: distritos2,
            backgroundColor: (context) => {
              if (context.dataIndex == null) {
                return null;
              }

              const value = context.dataset.data[context.dataIndex];
              return new Color('#78C2AD').blackness(value.value * 100).rgbString();
            },
              //data: distritos2.map((d) => ({feature: d, value: dict[d.properties.name]})),
              data: distritosPT.map((d) => ({feature: d, value: orgValues(d.properties.name)})),
          }]
        },
        options: {
          showOutline: true,
          legend: {
            display: false
          },
          scale: {
            projection: 'mercator'
          },
          tooltips: {
            callbacks: {
                afterLabel: function(tooltipItem, data) {
                  var distrito = data['labels'][tooltipItem['index']];
                  return "Union Organizations: " + dict[distrito];
                }
            }
          }
        }

      });

    });

     new Chart(document.getElementById("bar-chart2"), {
     type: 'bar',
     data: {
       labels: {{ dataset.barchart2_labels | safe }},
       datasets: [
        {
          label: "Strike Notices",
          data: {{ dataset.barchart2_data | safe }},
          backgroundColor: '#228B22' // green
        }
      ]
    },
    options: {
      legend: { display: true },
      scales: [{
        xAxes: [{
          scaleLabel: {
            display: true,
            labelString: 'year'
          }
        }],
        yAxes: [{
          scaleLabel: {
            display: true,
            labelString: 'strike notices'
          }
        }]
      }]
    }
    
    });

    var setores = {{ dataset.barchart3_labels | safe }};
    var setores_red = [];
    var pos = 0;
    var setores_final = {};


    for(pos = 0; pos < setores.length; pos++){
      setores_red.push(setores[pos].substring(0,20));
      setores_final[setores_red[pos]] = setores[pos];
    }

     new Chart(document.getElementById("bar-chart3"), {
     type: 'horizontalBar',
     data: {
       labels: setores_red,
       datasets: [
        {
          label: "Active Union Organizations",
          data: {{ dataset.barchart3_data | safe }},
          backgroundColor: '#0000FF' // blue
        }
      ]
    },
    options: {
      legend: { display: true },
      scales: {
        xAxes: [{
          ticks: {
            beginAtZero: true,
            stepSize: 200
          }
        }],
        yAxes: [{
            ticks: {
                fontSize: 10
            }
        }]
      },
      tooltips: {
        callbacks: {
            beforeLabel: function(tooltipItem, data) {
                var setor = data['labels'][tooltipItem['index']];
                return setores_final[setor];
            },
            title: function(tooltipItem, data) {}

        }
      }
    }
    });

    </script>

</body>
</html>